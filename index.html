<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tennis Voice & Keyboard Control</title>
  <style>
    body{
      margin:0;
      display:grid;
      place-items:center;
      min-height:100vh;
      background:#111;
      color:#eee;
      font-family:sans-serif
    }
    .game{
      position:relative;
      width:720px;
      height:400px;
      background:linear-gradient(#0e7a3a,#0a5a2b);
      border:3px solid #fff;
      border-radius:12px;
      overflow:hidden
    }
    .paddle{
      position:absolute;
      width:12px;
      height:80px;
      background:#eee;
      left:20px;
      top:50%;
      transform:translateY(-50%);
      border-radius:6px
    }
    .ball{
      position:absolute;
      width:16px;
      height:16px;
      border-radius:50%;
      background:#ffd200;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%)
    }
    .score{
      position:absolute;
      top:10px;
      right:10px;
      font-size:1.2rem;
      font-weight:bold
    }
    button{
      margin:10px 0;
      padding:8px 16px;
      font-size:1rem;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div>
    <h2>🎤🎮 Tennis Voice & Keyboard Control</h2>
    <button type="button" onclick="ensureMicThenInit()">شروع تشخیص صدا</button>
    <div id="label-container"></div>
  </div>

  <div class="game" id="game">
    <div class="paddle" id="paddle"></div>
    <div class="ball" id="ball"></div>
    <div class="score" id="score">0</div>
  </div>

  <!-- Tensorflow & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

  <script>
    const game = document.getElementById('game');
    const paddle = document.getElementById('paddle');
    const ball = document.getElementById('ball');
    const scoreEl = document.getElementById('score');

    let paddleY = game.clientHeight/2 - paddle.offsetHeight/2;
    let ballX = game.clientWidth/2;
    let ballY = game.clientHeight/2;
    let ballSpeedX = 1;
    let ballSpeedY = 1;
    let score = 0;
    let animationId = null;

    function movePaddle(dir){
      if(dir === 'up') paddleY -= 20;
      if(dir === 'down') paddleY += 20;
      if(paddleY < 0) paddleY = 0;
      if(paddleY > game.clientHeight - paddle.offsetHeight) paddleY = game.clientHeight - paddle.offsetHeight;
      paddle.style.top = paddleY + 'px';
    }

    // 🎮 کنترل پدل با کیبورد
    document.addEventListener('keydown', e => {
      if(e.key === 'ArrowUp') movePaddle('up');
      if(e.key === 'ArrowDown') movePaddle('down');
    });

    function update(){
      ballX += ballSpeedX;
      ballY += ballSpeedY;

      if(ballY <= 0 || ballY >= game.clientHeight - ball.offsetHeight){
        ballSpeedY *= -1;
      }
      if(ballX >= game.clientWidth - ball.offsetWidth){
        ballSpeedX *= -1;
      }
      if(ballX <= paddle.offsetLeft + paddle.offsetWidth){
        if(ballY + ball.offsetHeight >= paddleY && ballY <= paddleY + paddle.offsetHeight){
          ballSpeedX *= -1;
          score++;
          scoreEl.textContent = score;
        } else {
          cancelAnimationFrame(animationId); // توقف توپ
          alert('Game Over! امتیاز شما: ' + score);
          resetGame();
        }
      }

      ball.style.left = ballX + 'px';
      ball.style.top = ballY + 'px';
      animationId = requestAnimationFrame(update);
    }

    function resetGame(){
      score = 0;
      scoreEl.textContent = score;
      ballX = game.clientWidth/2;
      ballY = game.clientHeight/2;
      ballSpeedX = 3;
      ballSpeedY = 2;
      animationId = requestAnimationFrame(update);
    }

    update();

    // 🎤 Voice Recognition
    const URL = "https://b-sarkheil.github.io/VoiceTennis/"; 

    async function createModel() {
        const checkpointURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        const recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
        await recognizer.ensureModelLoaded();
        console.log("Model loaded!");
        return recognizer;
    }

    async function initVoice() {
      const recognizer = await createModel();
      const classLabels = recognizer.wordLabels();
      const labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = '';

      for (let i = 0; i < classLabels.length; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }     
      
      recognizer.listen(result => {
        const scores = result.scores;
        for (let i = 0; i < classLabels.length; i++) {
          const classPrediction = classLabels[i] + ": " + scores[i].toFixed(2);
          labelContainer.childNodes[i].innerHTML = classPrediction;
        }

        const maxIndex = scores.indexOf(Math.max(...scores));
        const command = classLabels[maxIndex];
        if(scores[maxIndex] > 0.5){
          if(command === 'Up'){ movePaddle('up'); }
          if(command === 'Down'){ movePaddle('down'); }
        }

      }, { probabilityThreshold: 0.75 });
    }

    async function ensureMicThenInit(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('مرورگر شما از میکروفن پشتیبانی نمی‌کند.');
        return;
      }
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch(err){
        alert('لطفاً اجازه‌ی دسترسی به میکروفن را بدهید تا کنترل صوتی کار کند.');
        return;
      }
      initVoice();
    }
  </script>
</body>
</html>
